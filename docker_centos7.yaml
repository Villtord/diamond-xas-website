FROM centos:7

USER root

RUN yum -y update && yum clean all && yum install -y wget && yum install -y vim

ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"

# get miniconda
RUN wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh

# install in batch (silent) mode, does not edit PATH or .bashrc or .bash_profile
RUN bash Miniconda3-latest-Linux-x86_64.sh -b

RUN conda update -y conda

# cleanup
RUN rm Miniconda3-latest-Linux-x86_64.sh

# install django app and dependencies
COPY xasdb/. /app

RUN conda env update --file app/requirements.yaml

# this will run as root but not as user at K8s - no further write access to created folders!
#RUN python /app/manage.py migrate

RUN chmod -R 777 /app && chmod 777 /root && chmod 777 /usr

# this will run as root but not as user at K8s - no further write access to created folders!
#RUN python -c "import larch"

EXPOSE 8085

WORKDIR /app

ENTRYPOINT ["/bin/sh"]
